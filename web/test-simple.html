<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>路径修复测试 - 简化版</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-item {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .loading { background: #fff3cd; border-color: #ffeaa7; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>🔧 路径修复测试 - 简化版</h1>
    
    <div class="test-item" id="envTest">
        <h3>📍 环境检测</h3>
        <div id="envInfo">检测中...</div>
    </div>

    <div class="test-item" id="scriptTest">
        <h3>📜 脚本加载测试</h3>
        <div id="scriptInfo">等待测试...</div>
        <button onclick="testScripts()">测试脚本加载</button>
    </div>

    <div class="test-item" id="storageTest">
        <h3>💾 存储功能测试</h3>
        <div id="storageInfo">等待测试...</div>
        <button onclick="testStorage()">测试存储功能</button>
    </div>

    <div class="test-item">
        <h3>📝 控制台日志</h3>
        <div id="consoleLog" class="log">日志将显示在这里...\n</div>
        <button onclick="clearLog()">清空日志</button>
    </div>

    <script>
        // 内联路径配置
        window.PathConfig = {
            getBasePath() {
                const hostname = window.location.hostname;
                const pathname = window.location.pathname;
                
                if (hostname.includes('github.io')) {
                    const pathParts = pathname.split('/').filter(p => p);
                    if (pathParts.length > 0) {
                        return '/' + pathParts[0];
                    }
                }
                return '';
            },
            
            getAssetPath(relativePath) {
                if (!relativePath) return '';
                if (!relativePath.startsWith('/')) {
                    relativePath = '/' + relativePath;
                }
                return this.getBasePath() + relativePath;
            },
            
            async loadScript(src) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = this.getAssetPath(src);
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }
        };

        let logElement = document.getElementById('consoleLog');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            logElement.textContent += logMessage;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            logElement.textContent = '日志已清空\n';
        }

        // 环境检测
        function detectEnvironment() {
            log('🔍 开始环境检测...');
            
            const env = {
                hostname: window.location.hostname,
                pathname: window.location.pathname,
                basePath: PathConfig.getBasePath()
            };
            
            const envInfo = document.getElementById('envInfo');
            envInfo.innerHTML = `
                <p><strong>主机名:</strong> ${env.hostname}</p>
                <p><strong>路径:</strong> ${env.pathname}</p>
                <p><strong>基础路径:</strong> ${env.basePath || '(空)'}</p>
                <p><strong>环境类型:</strong> ${env.hostname.includes('github.io') ? 'GitHub Pages' : '本地/其他'}</p>
            `;
            
            log(`✅ 环境检测完成: ${env.hostname.includes('github.io') ? 'GitHub Pages' : '本地/其他'} 环境`);
            if (env.basePath) {
                log(`📁 基础路径: ${env.basePath}`);
            }
            
            document.getElementById('envTest').className = 'test-item success';
        }

        async function testScripts() {
            log('📜 开始脚本加载测试...');
            document.getElementById('scriptTest').className = 'test-item loading';
            
            try {
                // 测试加载 storage.js
                log('正在加载 storage.js...');
                const storagePath = PathConfig.getAssetPath('/shared/storage.js');
                log(`📁 脚本路径: ${storagePath}`);
                
                await PathConfig.loadScript('/shared/storage.js');
                log('✅ storage.js 加载成功');
                
                // 检查 Storage 对象
                if (window.Storage) {
                    log('✅ Storage 对象已定义');
                    document.getElementById('scriptInfo').innerHTML = '✅ 脚本加载成功，Storage 对象可用';
                    document.getElementById('scriptTest').className = 'test-item success';
                } else {
                    log('❌ Storage 对象未定义');
                    document.getElementById('scriptInfo').innerHTML = '⚠️ 脚本加载但 Storage 对象不可用';
                    document.getElementById('scriptTest').className = 'test-item error';
                }
                
            } catch (error) {
                log(`❌ 脚本加载失败: ${error.message}`);
                document.getElementById('scriptInfo').innerHTML = `❌ 脚本加载失败: ${error.message}`;
                document.getElementById('scriptTest').className = 'test-item error';
            }
        }

        function testStorage() {
            log('💾 开始存储功能测试...');
            
            if (!window.Storage) {
                log('❌ Storage 对象不存在，无法测试');
                document.getElementById('storageInfo').innerHTML = '❌ Storage 对象不存在';
                document.getElementById('storageTest').className = 'test-item error';
                return;
            }
            
            try {
                // 测试存储
                Storage.set('test_key', 'test_value');
                log('✅ 存储测试数据成功');
                
                // 测试读取
                const value = Storage.get('test_key');
                if (value === 'test_value') {
                    log('✅ 读取测试数据成功');
                    document.getElementById('storageInfo').innerHTML = '✅ 存储功能正常';
                    document.getElementById('storageTest').className = 'test-item success';
                } else {
                    log('❌ 读取数据不匹配');
                    document.getElementById('storageInfo').innerHTML = '❌ 存储功能异常';
                    document.getElementById('storageTest').className = 'test-item error';
                }
                
            } catch (error) {
                log(`❌ 存储测试失败: ${error.message}`);
                document.getElementById('storageInfo').innerHTML = `❌ 存储测试失败: ${error.message}`;
                document.getElementById('storageTest').className = 'test-item error';
            }
        }

        // 页面加载完成后自动检测环境
        document.addEventListener('DOMContentLoaded', function() {
            log('🚀 测试页面已加载');
            detectEnvironment();
        });
    </script>
</body>
</html>
