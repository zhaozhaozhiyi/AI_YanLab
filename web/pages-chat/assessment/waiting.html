<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI评估中 - 逆龄小颜</title>
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- 自定义样式 -->
  <link rel="stylesheet" href="../../assets/css/base.css">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      width: 100%;
      overflow: hidden;
    }

    body {
      background: #f8f9fa;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .waiting-container {
      width: 100%;
      max-width: 480px;
      padding: 2rem;
      text-align: center;
    }

    /* Logo区域 */
    .logo {
      margin-bottom: 2rem;
    }

    /* Logo图标 */
    .logo-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      color: white;
      box-shadow: 0 10px 30px rgba(16, 185, 129, 0.25);
      animation: pulse 2s ease-in-out infinite;
    }

    /* 脉冲动画 */
    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 10px 30px rgba(16, 185, 129, 0.25);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 15px 40px rgba(16, 185, 129, 0.35);
      }
    }

    /* 标题 */
    .waiting-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 0.5rem;
    }

    .waiting-subtitle {
      font-size: 0.9rem;
      color: #6b7280;
      margin-bottom: 2rem;
    }

    /* 进度条区域 */
    .progress-wrapper {
      margin-bottom: 2rem;
    }

    .progress-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      font-size: 0.875rem;
      color: #6b7280;
    }

    .progress-bar-container {
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #059669);
      transition: width 0.3s ease;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    /* 步骤列表 */
    .steps-container {
      margin-top: 2rem;
      text-align: left;
    }

    .step-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.875rem;
      margin-bottom: 0.5rem;
      border-radius: 10px;
      transition: all 0.3s ease;
      opacity: 0.4;
    }

    .step-item.active {
      opacity: 1;
      background: rgba(16, 185, 129, 0.05);
    }

    .step-item.completed {
      opacity: 0.6;
    }

    .step-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: #f3f4f6;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      flex-shrink: 0;
      transition: all 0.3s ease;
    }

    .step-item.active .step-icon {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .step-item.completed .step-icon {
      background: #10b981;
      color: white;
    }

    .step-text {
      font-size: 0.9rem;
      color: #374151;
      font-weight: 500;
    }

    .step-item.active .step-text {
      color: #059669;
      font-weight: 600;
    }

    /* 简化动画 */
    @keyframes spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    .logo-icon i {
      animation: spin 2s linear infinite;
    }
  </style>
</head>
<body>
  <div class="waiting-container">
    <!-- Logo -->
    <div class="logo">
      <div class="logo-icon">
        <i class="fas fa-magic"></i>
      </div>
    </div>

    <!-- 标题 -->
    <h1 class="waiting-title">分析中</h1>
    <p class="waiting-subtitle">正在为您生成评估报告</p>

    <!-- 进度信息 -->
    <div class="progress-wrapper">
      <div class="progress-info">
        <span id="statusText">上传照片</span>
        <span id="progressText">0%</span>
      </div>
      <div class="progress-bar-container">
        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
      </div>
    </div>

    <!-- 步骤列表 -->
    <div class="steps-container">
      <div class="step-item" data-step="0">
        <div class="step-icon">
          <i class="fas fa-upload"></i>
        </div>
        <div class="step-text">上传照片</div>
      </div>

      <div class="step-item" data-step="1">
        <div class="step-icon">
          <i class="fas fa-search"></i>
        </div>
        <div class="step-text">识别特征</div>
      </div>

      <div class="step-item" data-step="2">
        <div class="step-icon">
          <i class="fas fa-brain"></i>
        </div>
        <div class="step-text">智能分析</div>
      </div>

      <div class="step-item" data-step="3">
        <div class="step-icon">
          <i class="fas fa-file-alt"></i>
        </div>
        <div class="step-text">生成报告</div>
      </div>
    </div>
  </div>

  <!-- 引入共享脚本 -->
  <script src="../../../shared/router.js"></script>
  <script src="../../../shared/utils.js"></script>
  <script src="../../../shared/storage.js"></script>
  <script src="../../../shared/mock.js"></script>

  <script>
    let currentStep = 0;
    let progress = 0;
    const totalSteps = 4;
    const totalTime = 5000; // 5秒快速完成评估
    const stepTime = totalTime / totalSteps;

    // 步骤描述
    const stepDescriptions = [
      { text: '正在上传您的面部照片...', progress: 25 },
      { text: 'AI正在识别面部特征点...', progress: 50 },
      { text: '深度分析皮肤状态和面部问题...', progress: 75 },
      { text: '正在生成个性化评估报告...', progress: 100 }
    ];

    // 更新进度
    function updateProgress() {
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const statusText = document.getElementById('statusText');
      const stepItems = document.querySelectorAll('.step-item');

      if (currentStep < totalSteps) {
        // 更新步骤状态
        stepItems.forEach((item, index) => {
          item.classList.remove('active', 'completed');
          if (index < currentStep) {
            item.classList.add('completed');
          } else if (index === currentStep) {
            item.classList.add('active');
          }
        });
        
        // 更新进度条和文字
        const targetProgress = stepDescriptions[currentStep].progress;
        const statusDescription = stepDescriptions[currentStep].text;
        
        statusText.textContent = statusDescription;
        
        // 平滑过渡进度条
        const progressInterval = setInterval(() => {
          progress += 1;
          progressBar.style.width = progress + '%';
          progressText.textContent = progress + '%';
          
          if (progress >= targetProgress) {
            clearInterval(progressInterval);
          }
        }, stepTime / (targetProgress - progress));

        currentStep++;
        
        if (currentStep < totalSteps) {
          setTimeout(updateProgress, stepTime);
        } else {
          setTimeout(completeAnalysis, stepTime);
        }
      }
    }

    // 完成分析
    function completeAnalysis() {
      const statusText = document.getElementById('statusText');
      statusText.textContent = '分析完成';
      
      // 标记所有步骤为完成
      const stepItems = document.querySelectorAll('.step-item');
      stepItems.forEach(item => {
        item.classList.remove('active');
        item.classList.add('completed');
      });
      
      // 生成模拟评估报告
      const assessment = Storage.get('currentAssessment');
      const report = generateMockReport(assessment);
      
      // 保存报告
      Storage.set('currentReport', report);
      
      // 更新评估状态
      assessment.status = 'completed';
      assessment.completedTime = Date.now();
      assessment.reportId = report.id;
      Storage.set('currentAssessment', assessment);
      
      // 保存到历史记录
      saveToHistory(report);
      
      // 跳转到报告页面
      setTimeout(() => {
        window.location.href = './skin-report.html';
      }, 1000);
    }

    // 生成模拟报告
    function generateMockReport(assessment) {
      const reportId = 'REPORT_' + Date.now();
      
      return {
        id: reportId,
        assessmentId: assessment.id,
        userId: assessment.userId,
        createdAt: Date.now(),
        overallScore: Math.floor(Math.random() * 15) + 75, // 75-90分
        ageScore: Math.floor(Math.random() * 20) + 70,
        skinScore: Math.floor(Math.random() * 20) + 70,
        faceScore: Math.floor(Math.random() * 20) + 70,
        estimatedAge: 28 + Math.floor(Math.random() * 5),
        actualAge: 32,
        issues: [
          {
            id: 1,
            name: '细纹与皱纹',
            severity: 'medium',
            score: 72,
            areas: ['眼周', '额头', '法令纹'],
            description: '在眼周和额头区域发现轻度细纹，建议及时进行抗衰护理。',
            suggestions: [
              '使用含视黄醇的眼霜',
              '定期进行补水护理',
              '考虑肉毒素注射治疗'
            ]
          },
          {
            id: 2,
            name: '肤色不均',
            severity: 'low',
            score: 78,
            areas: ['面颊', 'T区'],
            description: '面部肤色整体均匀，局部T区略有色差。',
            suggestions: [
              '使用美白精华液',
              '注意防晒保护',
              '定期去角质'
            ]
          },
          {
            id: 3,
            name: '毛孔粗大',
            severity: 'medium',
            score: 70,
            areas: ['鼻翼', '面颊'],
            description: 'T区毛孔较为明显，需要加强清洁和收敛护理。',
            suggestions: [
              '深层清洁面膜',
              '使用收敛水',
              '光子嫩肤治疗'
            ]
          }
        ],
        recommendations: [
          {
            priority: 'high',
            title: '抗衰老护理',
            treatments: ['肉毒素', '玻尿酸填充', '热玛吉'],
            estimatedCost: '8000-15000元',
            duration: '3-6个月'
          },
          {
            priority: 'medium',
            title: '肤质改善',
            treatments: ['光子嫩肤', '水光针', '果酸焕肤'],
            estimatedCost: '3000-8000元',
            duration: '1-3个月'
          }
        ],
        strengths: [
          '面部轮廓清晰，骨骼结构良好',
          '皮肤底子较好，无明显色斑',
          '五官比例协调'
        ]
      };
    }

    // 保存到历史记录
    function saveToHistory(report) {
      let history = Storage.get('assessmentHistory') || [];
      history.unshift({
        id: report.id,
        date: report.createdAt,
        score: report.overallScore,
        preview: '面部综合评估报告'
      });
      
      // 只保留最近20条记录
      if (history.length > 20) {
        history = history.slice(0, 20);
      }
      
      Storage.set('assessmentHistory', history);
      Storage.set('report_' + report.id, report);
    }

    // 页面加载时开始评估
    window.addEventListener('load', () => {
      // 检查是否有评估数据
      const assessment = Storage.get('currentAssessment');
      if (!assessment) {
        alert('未找到评估数据');
        window.location.href = './guide.html';
        return;
      }
      
      // 延迟开始，让动画先展示
      setTimeout(() => {
        updateProgress();
      }, 1000);
    });

    // 防止用户返回
    window.addEventListener('popstate', (e) => {
      if (confirm('评估正在进行中，确定要取消吗？')) {
        // 清理评估数据
        Storage.remove('currentAssessment');
        Storage.remove('capturedPhotos');
      } else {
        // 阻止返回
        window.history.pushState(null, '', window.location.href);
      }
    });

    // 添加一个历史记录条目以防止返回
    window.history.pushState(null, '', window.location.href);
  </script>
</body>
</html>


