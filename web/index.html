<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é€†é¾„å°é¢œ</title>
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- è‡ªå®šä¹‰æ ·å¼ -->
  <link rel="stylesheet" href="./assets/css/base.css">
  
  <!-- Storage å·¥å…· -->
  <script src="../shared/storage.js"></script>
  
  <style>
    body {
      background: #ffffff;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    /* èƒŒæ™¯åŠ¨ç”»å±‚ */
    #animatedBackground {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      pointer-events: none;
      overflow: hidden;
    }

    /* ç²’å­å±‚ */
    .particle-layer {
      position: absolute;
      width: 100%;
      height: 100%;
    }

    .particle {
      position: absolute;
      width: 2px;
      height: 2px;
      background: radial-gradient(circle, #34C759 0%, transparent 70%);
      border-radius: 50%;
      opacity: 0.3;
      animation: float 20s infinite ease-in-out;
    }

    @keyframes float {
      0%, 100% {
        transform: translate(0, 0);
        opacity: 0.2;
      }
      25% {
        opacity: 0.5;
      }
      50% {
        transform: translate(50px, -30px);
        opacity: 0.3;
      }
      75% {
        opacity: 0.4;
      }
    }

    /* ç½‘æ ¼çº¿ */
    .grid-overlay {
      position: absolute;
      width: 100%;
      height: 100%;
      background-image: 
        linear-gradient(rgba(52, 199, 89, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(52, 199, 89, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
      animation: gridMove 20s linear infinite;
    }

    @keyframes gridMove {
      0% {
        transform: translate(0, 0);
      }
      100% {
        transform: translate(50px, 50px);
      }
    }

    /* æ¸å˜æ³¡æ³¡ */
    .gradient-orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(60px);
      opacity: 0.08;
    }

    .orb-1 {
      width: 300px;
      height: 300px;
      background: linear-gradient(135deg, #34C759, #22c55e);
      top: 5%;
      left: -10%;
      animation: orb1 25s ease-in-out infinite;
    }

    @keyframes orb1 {
      0%, 100% {
        transform: translate(0, 0);
      }
      50% {
        transform: translate(100px, 50px);
      }
    }

    /* ä¸»å†…å®¹åŒºåŸŸ - ç¡®ä¿å±‚çº§åœ¨èƒŒæ™¯ä¹‹ä¸Š */
    .main-content-wrapper {
      position: relative;
      z-index: 1;
    }

    /* æ‚¬æµ®çš„"æˆ‘çš„"æŒ‰é’® */
    .floating-profile-button {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(229, 231, 235, 0.8);
      color: #374151;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      z-index: 100;
      text-decoration: none;
    }

    .floating-profile-button:hover {
      background: rgba(255, 255, 255, 1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
      transform: translateY(-1px);
    }

    .floating-profile-button:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .floating-profile-button i {
      font-size: 1.25rem;
    }

    /* é¡¶éƒ¨æ ‡é¢˜ */
    .chat-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 1rem 1.5rem;
      background: transparent;
    }

    .chat-title {
      font-size: 1.75rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 1rem;
      letter-spacing: 0.5px;
    }

    /* è™šæ‹ŸåŠ©æ‰‹å¤´åƒ */
    .assistant-avatar-wrapper {
      position: relative;
      margin-bottom: 1rem;
    }

    .assistant-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, #34C759 0%, #22c55e 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .assistant-avatar::before {
      content: '';
      position: absolute;
      inset: -3px;
      border-radius: 50%;
      background: linear-gradient(135deg, #34C759, #22c55e, #4ade80, #6fd88f);
      z-index: -1;
      animation: rotate-gradient 3s linear infinite;
    }

    @keyframes rotate-gradient {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .assistant-avatar-inner {
      width: 114px;
      height: 114px;
      border-radius: 50%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .assistant-avatar-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    .assistant-icon {
      font-size: 3rem;
      background: linear-gradient(135deg, #34C759, #22c55e);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* éŸ³é¢‘å›¾æ ‡ */
    .audio-icon {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 28px;
      height: 28px;
      background: #34C759;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      box-shadow: 0 2px 8px rgba(52, 199, 89, 0.3);
      animation: audio-pulse 2s ease-in-out infinite;
    }

    @keyframes audio-pulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 2px 8px rgba(52, 199, 89, 0.3);
      }
      50% {
        transform: scale(1.1);
        box-shadow: 0 4px 16px rgba(52, 199, 89, 0.5);
      }
    }

    /* é—®å€™è¯­ */
    .greeting {
      font-size: 1rem;
      color: #6b7280;
      font-weight: 500;
    }

    /* åŠ©æ‰‹èƒ½åŠ›åŒºåŸŸ */
    .capabilities-section {
      padding: 1rem 2rem;
      padding-top: 0.5rem;
    }

    .capability-grid {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1.5rem;
      max-width: 600px;
      margin: 0 auto;
      padding: 0;
    }

    .capability-grid .capability-card[style*="display: none"] {
      display: none !important;
    }

    .capability-card {
      background: linear-gradient(135deg, rgba(248, 250, 252, 0.9) 0%, rgba(241, 245, 249, 0.95) 100%);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 1.25rem 1.5rem;
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.04);
      transition: all 0.3s ease;
      cursor: pointer;
      border: none;
      min-width: 180px;
      flex: 1;
      width: 100%;
      /* max-width: 250px; */
    }

    .capability-card:hover {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 1) 100%);
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12), 0 2px 6px rgba(0, 0, 0, 0.08);
    }

    .capability-card.active {
      background: rgba(52, 199, 89, 0.08);
      transform: scale(1.02);
    }

    .capability-card.active .capability-icon {
      background: rgba(52, 199, 89, 0.15);
    }

    .capability-card.active .capability-name {
      color: #34C759;
      font-weight: 600;
    }

    .capability-icon {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.125rem;
      transition: all 0.3s ease;
      flex-shrink: 0;
      position: relative;
      z-index: 1;
    }

    .capability-icon-globe {
      background: rgba(59, 130, 246, 0.12);
      color: #3b82f6;
    }

    .capability-icon-camera {
      background: rgba(236, 72, 153, 0.12);
      color: #ec4899;
    }

    .capability-icon-nurse {
      background: rgba(16, 185, 129, 0.12);
      color: #10b981;
    }

    .capability-name {
      font-size: 1rem;
      font-weight: 600;
      color: #1f2937;
      text-align: left;
      letter-spacing: 0.2px;
      flex: 1;
      line-height: 1.4;
      padding-left: 0.5rem;
      position: relative;
      z-index: 1;
    }

    /* ä¸¤ä¸ªæŒ‰é’®å¡ç‰‡ä¸åŒçš„èƒŒæ™¯ - é€†é¾„ç§˜å¢ƒï¼ˆç²‰ç´«è‰²æ—‹è½¬æ¸å˜ï¼‰ */
    .capability-card:nth-child(2) {
      background: linear-gradient(135deg, rgba(252, 231, 243, 0.06), rgba(249, 168, 212, 0.09));
      position: relative;
      overflow: hidden;
    }

    .capability-card:nth-child(2)::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: conic-gradient(
        from 0deg,
        transparent,
        rgba(249, 168, 212, 0.06),
        transparent,
        rgba(252, 231, 243, 0.04),
        transparent
      );
      animation: rotate-pink 4s linear infinite;
      z-index: 0;
      pointer-events: none;
    }

    .capability-card:nth-child(2):hover::before {
      animation-play-state: paused;
    }

    /* ä¸¤ä¸ªæŒ‰é’®å¡ç‰‡ä¸åŒçš„èƒŒæ™¯ - æœ¯åç®¡å®¶ï¼ˆé’ç»¿æ—‹è½¬æ¸å˜ï¼‰ */
    .capability-card:nth-child(3) {
      background: linear-gradient(135deg, rgba(209, 250, 229, 0.06), rgba(134, 239, 172, 0.09));
      position: relative;
      overflow: hidden;
    }

    .capability-card:nth-child(3)::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: conic-gradient(
        from 180deg,
        transparent,
        rgba(134, 239, 172, 0.06),
        transparent,
        rgba(209, 250, 229, 0.04),
        transparent
      );
      animation: rotate-green 5s linear infinite;
      z-index: 0;
      pointer-events: none;
    }

    .capability-card:nth-child(3):hover::before {
      animation-play-state: paused;
    }

    /* æ—‹è½¬åŠ¨ç”» */
    @keyframes rotate-pink {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    @keyframes rotate-green {
      from {
        transform: rotate(180deg);
      }
      to {
        transform: rotate(540deg);
      }
    }

    /* å»ºè®®é—®é¢˜åŒºåŸŸ */
    .suggested-questions-section {
      padding: 1.5rem 1rem;
    }

    .suggestions-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .suggestion-hint {
      font-size: 1rem;
      font-weight: 600;
      color: #374151;
    }

    .refresh-button {
      background: none;
      border: none;
      color: #9ca3af;
      padding: 0;
      font-size: 0.8125rem;
      font-weight: 400;
      cursor: pointer;
      transition: color 0.3s ease, transform 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .refresh-button:hover {
      color: #34C759;
    }

    .refresh-button i {
      font-size: 0.75rem;
      transition: transform 0.5s ease;
    }

    .refresh-button.rotating i {
      animation: rotate 0.5s ease;
    }

    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* æ»šåŠ¨å®¹å™¨ - æ°´å¹³æ»šåŠ¨ */
    .questions-scroll-container {
      overflow-x: auto;
      overflow-y: hidden;
      scrollbar-width: none;
      -ms-overflow-style: none;
      position: relative;
      scroll-behavior: smooth;
      padding: 0.5rem 0;
    }

    .questions-scroll-container::-webkit-scrollbar {
      display: none;
    }

    .questions-scroll-wrapper {
      display: flex;
      gap: 0.75rem;
      width: max-content;
    }

    /* ä¸‰æ’æ•´ä½“å®¹å™¨ - ä½œä¸ºä¸€ä¸ªè½®æ’­å•å…ƒ */
    .questions-swiper {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      flex-shrink: 0;
      min-width: max-content;
    }

    /* æ¯ä¸€æ’ - ç¡®ä¿é—´è·å®Œå…¨ä¸€è‡´ */
    .question-row {
      display: flex;
      gap: 0.75rem;
      flex-shrink: 0;
      align-items: center;
      min-height: 36px;
    }

    .question-card {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 0.5rem 0.875rem;
      display: inline-flex;
      flex-direction: row;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
      cursor: pointer;
      border: 1px solid rgba(229, 231, 235, 0.6);
      white-space: nowrap;
      flex: 0 0 auto;
    }

    .question-card:hover {
      background: rgba(255, 255, 255, 0.95);
      transform: translateY(-2px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }

    .question-icon {
      width: 20px;
      height: 20px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.625rem;
      flex-shrink: 0;
      opacity: 0.6;
    }

    .question-icon-blue {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
    }

    .question-icon-pink {
      background: rgba(236, 72, 153, 0.1);
      color: #ec4899;
    }

    .question-icon-green {
      background: rgba(16, 185, 129, 0.1);
      color: #10b981;
    }

    .question-text {
      font-size: 0.75rem;
      color: #374151;
      font-weight: 400;
      white-space: nowrap;
      line-height: 1.2;
    }

    /* è¾“å…¥æ¡†åŒºåŸŸ */
    .message-input-area {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 1rem;
      background: white;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 0.75rem;
      align-items: center;
      z-index: 40;
      padding-bottom: calc(1rem + env(safe-area-inset-bottom));
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.05);
    }

    .message-input {
      flex: 1;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 24px;
      padding: 0.75rem 1.25rem;
      font-size: 0.9375rem;
      color: #374151;
      outline: none;
      transition: all 0.3s ease;
    }

    .message-input:focus {
      background: white;
      border-color: #34C759;
      box-shadow: 0 0 0 3px rgba(52, 199, 89, 0.1);
    }

    .message-input::placeholder {
      color: #9ca3af;
    }

    .voice-button {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #34C759, #22c55e);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 1.25rem;
      cursor: pointer;
      transition: all 0.3s ease;
      flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3);
    }

    .voice-button:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(52, 199, 89, 0.4);
    }

    .voice-button:active {
      transform: scale(0.95);
    }

    /* å½•éŸ³çŠ¶æ€æ ·å¼ */
    .voice-button.recording {
      animation: recording-pulse 1s ease-in-out infinite;
    }

    @keyframes recording-pulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(52, 199, 89, 0.6);
      }
    }

    /* å½•éŸ³åŠ¨ç”»æç¤º */
    .recording-indicator {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(52, 199, 89, 0.95);
      backdrop-filter: blur(10px);
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 50px;
      display: none;
      align-items: center;
      gap: 0.75rem;
      box-shadow: 0 4px 16px rgba(52, 199, 89, 0.4);
      z-index: 100;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .recording-indicator.active {
      display: flex;
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translate(-50%, 20px);
      }
      to {
        opacity: 1;
        transform: translate(-50%, 0);
      }
    }

    .recording-indicator .wave {
      display: flex;
      gap: 3px;
      align-items: center;
    }

    .recording-indicator .wave span {
      width: 3px;
      height: 20px;
      background: white;
      border-radius: 2px;
      animation: wave-animation 1s ease-in-out infinite;
    }

    .recording-indicator .wave span:nth-child(1) {
      animation-delay: 0s;
    }

    .recording-indicator .wave span:nth-child(2) {
      animation-delay: 0.1s;
    }

    .recording-indicator .wave span:nth-child(3) {
      animation-delay: 0.2s;
    }

    .recording-indicator .wave span:nth-child(4) {
      animation-delay: 0.3s;
    }

    @keyframes wave-animation {
      0%, 100% {
        height: 10px;
      }
      50% {
        height: 24px;
      }
    }

    /* ä¸»å†…å®¹åŒº */
    .main-content {
      padding-bottom: 90px; /* ä¸ºåº•éƒ¨è¾“å…¥æ¡†ç•™ç©ºé—´ */
      min-height: calc(100vh - 120px);
    }

    /* å“åº”å¼ */
    @media (min-width: 640px) {
      .chat-title {
        font-size: 2rem;
      }

      .assistant-avatar {
        width: 140px;
        height: 140px;
      }

      .assistant-avatar-inner {
        width: 134px;
        height: 134px;
      }

      .assistant-icon {
        font-size: 3.5rem;
      }

      .capability-grid {
        gap: 2rem;
      }

      .capability-card {
        padding: 1.5rem 2rem;
        /* min-width: 220px; */
      }

      .capability-icon {
        width: 44px;
        height: 44px;
        font-size: 1.25rem;
      }

      .capability-name {
        font-size: 1.125rem;
      }
    }

    /* ç§»åŠ¨ç«¯å°å±å¹•ä¼˜åŒ– */
    @media (max-width: 360px) {
      .floating-profile-button {
        top: 15px;
        right: 15px;
        width: 40px;
        height: 40px;
      }

      .floating-profile-button i {
        font-size: 1.125rem;
      }

      .capabilities-section {
        padding: 1rem 1.5rem;
      }

      .capability-grid {
        gap: 1rem;
      }

      .capability-card {
        padding: 1rem 1.25rem;
        min-width: 160px;
      }

      .capability-icon {
        width: 40px;
        height: 40px;
        font-size: 1.125rem;
      }

      .capability-name {
        font-size: 0.9375rem;
      }

      .question-card {
        padding: 0.5rem 0.875rem;
      }

      .question-text {
        font-size: 0.75rem;
      }
    }

    /* è¶…å°å±æˆ–å¤§å±è‡ªé€‚åº” */
    @media (max-width: 480px) {
      .question-card {
        padding: 0.5rem 0.875rem;
      }
    }

    @media (min-width: 768px) {
      .questions-scroll-container {
        max-height: 400px;
      }
    }

    /* ==================== èŠå¤©æ¶ˆæ¯æ ·å¼ ==================== */
    .chat-messages-section {
      display: none;
      padding: 1rem;
      padding-bottom: calc(100px + env(safe-area-inset-bottom));
      min-height: 200px;
    }

    .messages-container {
      max-width: 800px;
      margin: 0 auto;
    }

    .message-item {
      display: flex;
      margin-bottom: 1rem;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-item.user {
      justify-content: flex-end;
    }

    .message-item.assistant {
      justify-content: flex-start;
    }

    .message-bubble {
      max-width: 75%;
      padding: 0.75rem 1rem;
      border-radius: 18px;
      position: relative;
      word-wrap: break-word;
      white-space: normal;
      line-height: 1.6;
      font-size: 0.9375rem;
      color: #374151;
      display: flex;
      flex-direction: column;
    }

    .message-text {
      line-height: 1.6;
    }

    .message-text strong {
      font-weight: 600;
      color: #1f2937;
    }

    .message-text p {
      margin: 0.5rem 0;
      line-height: 1.6;
    }

    .message-text ul, .message-text ol {
      margin: 0.5rem 0;
      padding-left: 1.5rem;
    }

    .message-text li {
      margin: 0.25rem 0;
      line-height: 1.5;
    }

    .message-item.user .message-bubble {
      background: linear-gradient(135deg, #34C759, #22c55e);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message-item.assistant .message-bubble {
      background: white;
      border: 1px solid #e5e7eb;
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      margin: 0 0.5rem;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f3f4f6;
      color: #6b7280;
      font-size: 0.875rem;
    }

    .message-item.user .message-avatar {
      order: 2;
      background: linear-gradient(135deg, #34C759, #22c55e);
      color: white;
    }

    .message-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .message-meta {
      font-size: 0.6875rem;
      color: #9ca3af;
      margin-top: 0.5rem;
      text-align: right;
      align-self: flex-end;
    }

    .message-item.assistant .message-bubble .message-meta {
      text-align: right;
    }

    /* æ‰“å­—åŠ¨ç”» */
    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 0.5rem 0;
      align-items: center;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: #9ca3af;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
      }
      30% {
        transform: translateY(-10px);
      }
    }

    /* å“åº”å¼è°ƒæ•´ */
    @media (max-width: 480px) {
      .message-bubble {
        max-width: 80%;
        padding: 0.625rem 0.875rem;
        font-size: 0.875rem;
      }

      .message-avatar {
        width: 32px;
        height: 32px;
        font-size: 0.75rem;
      }
    }

    /* ==================== Sticky Header ==================== */
    .sticky-header {
      position: sticky;
      top: 0;
      z-index: 60;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.98) 0%, rgba(255, 255, 255, 0.92) 100%);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(229, 231, 235, 0.8);
      padding: 0.875rem 1rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 1px 8px rgba(0, 0, 0, 0.04);
    }

    .sticky-header.hidden {
      opacity: 0;
      transform: translateY(-100%);
      pointer-events: none;
    }

    .sticky-header-content {
      max-width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .sticky-header-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1f2937;
      letter-spacing: 0.5px;
      margin: 0;
    }

    .sticky-profile-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(229, 231, 235, 0.8);
      color: #374151;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      text-decoration: none;
    }

    .sticky-profile-btn:hover {
      background: rgba(255, 255, 255, 1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
      transform: translateY(-1px);
    }

    .sticky-profile-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .sticky-profile-btn i {
      font-size: 1.125rem;
    }

    /* Sticky åŠŸèƒ½å¡ç‰‡åŒºåŸŸ */
    .sticky-cards-section {
      position: sticky;
      top: 64px;
      z-index: 59;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.98) 0%, rgba(255, 255, 255, 0.92) 100%);
      backdrop-filter: blur(20px);
      padding: 1rem;
      border-bottom: 1px solid rgba(229, 231, 235, 0.8);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .sticky-cards-section.hidden {
      display: none;
    }

    .sticky-cards-grid {
      display: flex;
      justify-content: center;
      gap: 1rem;
      max-width: 600px;
      margin: 0 auto;
    }

    .sticky-capability-card {
      flex: 1;
      max-width: 260px;
      background: white;
      border-radius: 16px;
      padding: 0.875rem 1.25rem;
      display: flex;
      align-items: center;
      gap: 0.875rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      transition: all 0.3s ease;
      cursor: pointer;
      border: 1px solid rgba(229, 231, 235, 0.6);
    }

    .sticky-capability-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
    }

    .sticky-capability-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      flex-shrink: 0;
    }

    .sticky-capability-name {
      font-size: 0.9375rem;
      font-weight: 600;
      color: #1f2937;
    }

    @media (max-width: 640px) {
      .sticky-header {
        padding: 0.75rem 1rem;
      }

      .sticky-header-title {
        font-size: 1.125rem;
      }

      .sticky-profile-btn {
        width: 36px;
        height: 36px;
      }

      .sticky-profile-btn i {
        font-size: 1rem;
      }

      .sticky-cards-section {
        top: 58px;
        padding: 0.875rem;
      }

      .sticky-cards-grid {
        gap: 0.75rem;
      }

      .sticky-capability-card {
        padding: 0.75rem 1rem;
      }

      .sticky-capability-icon {
        width: 32px;
        height: 32px;
        font-size: 0.875rem;
      }

      .sticky-capability-name {
        font-size: 0.875rem;
      }
    }
  </style>
</head>
<body>
  
  <!-- èƒŒæ™¯åŠ¨ç”»å±‚ -->
  <div id="animatedBackground">
    <!-- æ¸å˜æ³¡æ³¡ -->
    <div class="gradient-orb orb-1"></div>
    
    <!-- ç½‘æ ¼çº¿ -->
    <div class="grid-overlay"></div>
    
    <!-- ç²’å­å±‚ -->
    <div class="particle-layer" id="particleContainer"></div>
  </div>
  
  <!-- ä¸»å†…å®¹å±‚ -->
  <div class="main-content-wrapper">
    <!-- æ‚¬æµ®çš„"æˆ‘çš„"æŒ‰é’® -->
    <a href="/web/pages-chat/profile/index.html" class="floating-profile-button">
      <i class="fas fa-user"></i>
    </a>

    <!-- Sticky Header (æ»šåŠ¨æ—¶æ˜¾ç¤º) -->
    <div class="sticky-header hidden" id="stickyHeader">
      <div class="sticky-header-content">
        <h1 class="sticky-header-title">é€†é¾„å°é¢œ</h1>
        <a href="/web/pages-chat/profile/index.html" class="sticky-profile-btn">
          <i class="fas fa-user"></i>
        </a>
      </div>
    </div>

    <!-- Sticky åŠŸèƒ½å¡ç‰‡åŒºåŸŸ -->
    <div class="sticky-cards-section hidden" id="stickyCardsSection">
      <div class="sticky-cards-grid">
        <div class="sticky-capability-card" onclick="openCapability('assessment')">
          <div class="sticky-capability-icon capability-icon-camera">
            <i class="fas fa-camera"></i>
          </div>
          <div class="sticky-capability-name">é€†é¾„ç§˜å¢ƒ</div>
        </div>
        <div class="sticky-capability-card" onclick="openCapability('care')">
          <div class="sticky-capability-icon capability-icon-nurse">
            <i class="fas fa-user-nurse"></i>
          </div>
          <div class="sticky-capability-name">æœ¯åç®¡å®¶</div>
        </div>
      </div>
    </div>
  
  <!-- èŠå¤©å¤´éƒ¨ -->
  <div class="chat-header">
    <h1 class="chat-title">é€†é¾„å°é¢œ</h1>
    
    <div class="assistant-avatar-wrapper">
      <div class="assistant-avatar">
        <div class="assistant-avatar-inner">
          <img src="./assets/images/NiLing/peple.png" alt="å°é¢œåŒ»ç”Ÿ" class="assistant-avatar-img">
        </div>
      </div>
      <div class="audio-icon">
        <i class="fas fa-volume-up"></i>
      </div>
    </div>
    
    <p class="greeting">HELLO, å°é¢œåŒ»ç”Ÿ</p>
  </div>

  <!-- åŠ©æ‰‹èƒ½åŠ›åŒºåŸŸ -->
  <section class="capabilities-section">
    <div class="capability-grid">
    

      <!-- é€†é¾„ç§˜å¢ƒ -->
      <div class="capability-card" onclick="openCapability('assessment')">
        <div class="capability-icon capability-icon-camera">
          <i class="fas fa-camera"></i>
        </div>
        <div class="capability-name">é€†é¾„ç§˜å¢ƒ</div>
      </div>

      <!-- æœ¯åç®¡å®¶ -->
      <div class="capability-card" onclick="openCapability('care')">
        <div class="capability-icon capability-icon-nurse">
          <i class="fas fa-user-nurse"></i>
        </div>
        <div class="capability-name">æœ¯åç®¡å®¶</div>
      </div>
    </div>
  </section>

  <!-- å»ºè®®é—®é¢˜åŒºåŸŸ -->
  <section class="suggested-questions-section" id="suggestedQuestionsSection">
    <!-- æ ‡é¢˜åŒºåŸŸ -->
    <div class="suggestions-header">
      <p class="suggestion-hint">çŒœä½ æƒ³é—®</p>
      <button class="refresh-button" onclick="refreshQuestions()">
        <i class="fas fa-sync-alt"></i>
        <span>æ¢ä¸€æ¢</span>
      </button>
    </div>
    
    <!-- æ»šåŠ¨å®¹å™¨ -->
    <div class="questions-scroll-container" id="questionsScrollContainer">
      <div class="questions-scroll-wrapper" id="questionsScrollWrapper">
        <!-- é—®é¢˜ä¼šé€šè¿‡JSåŠ¨æ€ç”Ÿæˆï¼Œåˆ†æˆä¸‰æ’ -->
      </div>
    </div>
  </section>

  <!-- æ¶ˆæ¯åˆ—è¡¨åŒºåŸŸ -->
  <section class="chat-messages-section" id="chatMessagesSection">
    <div class="messages-container" id="messagesContainer">
      <!-- æ¶ˆæ¯ä¼šé€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
    </div>
  </section>

  <!-- å½•éŸ³æç¤º -->
  <div class="recording-indicator" id="recordingIndicator">
    <div class="wave">
      <span></span>
      <span></span>
      <span></span>
      <span></span>
    </div>
    <span id="recordingText"></span>
  </div>

  <!-- è¾“å…¥æ¡†åŒºåŸŸ -->
  <div class="message-input-area">
    <input 
      type="text" 
      placeholder="ç»™å°é¢œåŒ»ç”Ÿå‘é€æ¶ˆæ¯" 
      class="message-input"
      id="messageInput"
      onkeypress="handleEnterKey(event)"
    >
    <button class="voice-button" id="voiceButton" 
            onmousedown="handleVoiceInput(event)" 
            onmouseup="stopRecordingOnRelease(event)"
            ontouchstart="handleVoiceInput(event)"
            ontouchend="stopRecordingOnRelease(event)"
            ontouchcancel="stopRecordingOnRelease(event)">
      <i class="fas fa-microphone"></i>
    </button>
  </div>

  <script>
    // è¯­éŸ³å½•éŸ³ç›¸å…³å˜é‡
    let mediaRecorder = null;
    let isRecording = false;
    let audioChunks = [];
    let recordingStartTime = null;
    let recordingTimer = null;
    let hasPermission = false;

    // ==================== å¯¹è¯åŠŸèƒ½ä»£ç  ====================
    let conversationMessages = [];
    let isConversationStarted = false;
    let currentConversationId = null;

    // åˆå§‹åŒ–èŠå¤©
    function initChat() {
      // ä» localStorage åŠ è½½å†å²å¯¹è¯
      conversationMessages = Storage.get('chatMessages') || [];
      
      // åŠ è½½ conversation_id
      currentConversationId = Storage.get('currentConversationId') || null;
      
      if (conversationMessages.length > 0) {
        showChatMessages();
        renderMessages();
      }
    }

    // æ˜¾ç¤ºèŠå¤©åŒºåŸŸï¼ˆéšè—å»ºè®®é—®é¢˜ï¼‰
    function showChatMessages() {
      const suggestedSection = document.getElementById('suggestedQuestionsSection');
      const chatSection = document.getElementById('chatMessagesSection');
      
      if (suggestedSection && chatSection) {
        suggestedSection.style.display = 'none';
        chatSection.style.display = 'block';
        isConversationStarted = true;
      }
    }

    // æ¸²æŸ“æ‰€æœ‰æ¶ˆæ¯
    function renderMessages() {
      const container = document.getElementById('messagesContainer');
      if (!container) return;
      
      container.innerHTML = '';
      
      conversationMessages.forEach((msg) => {
        appendMessage(msg, false);
      });
      
      scrollToBottom();
    }

    // æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹ï¼ˆåŠ ç²—å…³é”®è¯ã€æ ‡é¢˜ç­‰ï¼‰
    function formatMessageContent(content) {
      if (!content) return '';
      
      // ä¿æŠ¤å·²ç»æ ¼å¼åŒ–çš„ HTML
      if (content.includes('<')) return content;
      
      let formatted = content
        // åŒ¹é… "æ ‡é¢˜:" æ ¼å¼å¹¶åŠ ç²—
        .replace(/([\u4e00-\u9fa5]{2,6}[ï¼š:])/g, '<strong style="font-weight: 600;">$1</strong>')
        // åŒ¹é… ã€å…³é”®è¯ã€‘æ ¼å¼
        .replace(/ã€([^ã€‘]+)ã€‘/g, '<strong style="font-weight: 600;">ã€$1ã€‘</strong>')
        // åŒ¹é…æ•°å­—ç¼–å·çš„æ ‡é¢˜
        .replace(/(\d+\.\s+)([^\n]+)/g, '<strong style="font-weight: 600;">$1$2</strong>')
        // åŒ¹é… â€¢ æˆ– Â· å¼€å¤´çš„é¡¹ç›®
        .replace(/([â€¢Â·]\s*)([^\n]+)/g, '<span style="display: block; margin: 0.25rem 0;"><strong style="font-weight: 600;">$1</strong>$2</span>')
        // æ¢è¡Œè½¬æ¢ä¸º <br>ï¼Œä½†å»é™¤å¤šä½™ç©ºè¡Œ
        .replace(/\n{2,}/g, '<br><br>')
        .replace(/\n/g, '<br>');
      
      return formatted;
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
    function appendMessage(msg, scroll = true) {
      const container = document.getElementById('messagesContainer');
      if (!container) return;
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `message-item ${msg.isUser ? 'user' : 'assistant'}`;
      
      if (msg.isUser) {
        messageDiv.innerHTML = `
          <div class="message-bubble">${msg.content}</div>
          <div class="message-avatar">
            <i class="fas fa-user"></i>
          </div>
        `;
      } else {
        const formattedContent = formatMessageContent(msg.content);
        messageDiv.innerHTML = `
          <div class="message-avatar">
            <img src="./assets/images/NiLing/peple.png" alt="å°é¢œåŒ»ç”Ÿ" onerror="this.parentElement.innerHTML='<i class=&quot;fas fa-user-nurse&quot;></i>'">
          </div>
          <div class="message-bubble">
            <div class="message-text">${formattedContent}</div>
            <div class="message-meta">${msg.timestamp}</div>
          </div>
        `;
      }
      
      container.appendChild(messageDiv);
      
      if (scroll) {
        scrollToBottom();
      }
    }

    // æ»šåŠ¨åˆ°åº•éƒ¨
    function scrollToBottom() {
      setTimeout(() => {
        window.scrollTo({
          top: document.body.scrollHeight,
          behavior: 'smooth'
        });
      }, 100);
    }

    // æ·»åŠ æµå¼æ¶ˆæ¯ï¼ˆåˆå§‹ä¸ºç©ºï¼‰
    function appendStreamingMessage(msg) {
      const container = document.getElementById('messagesContainer');
      if (!container) return;
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `message-item assistant`;
      messageDiv.id = `msg-${msg.id}`;
      messageDiv.innerHTML = `
        <div class="message-avatar">
          <img src="./assets/images/NiLing/peple.png" alt="å°é¢œåŒ»ç”Ÿ" onerror="this.parentElement.innerHTML='<i class=&quot;fas fa-user-nurse&quot;></i>'">
        </div>
        <div class="message-bubble">
          <div class="message-text" id="msg-content-${msg.id}"></div>
          <div class="message-meta">${msg.timestamp}</div>
        </div>
      `;
      
      container.appendChild(messageDiv);
      scrollToBottom();
    }

    // æ›´æ–°æµå¼æ¶ˆæ¯å†…å®¹
    function updateStreamingMessage(msgId, content) {
      const contentElement = document.getElementById(`msg-content-${msgId}`);
      if (contentElement) {
        // æ˜¾ç¤ºçº¯æ–‡æœ¬ï¼Œä¿ç•™æ¢è¡Œç¬¦
        // ä½¿ç”¨ innerHTML å°†æ¢è¡Œè½¬æ¢ä¸º <br>ï¼Œé¿å…é‡å¤æ ¼å¼åŒ–
        const withBreaks = content.replace(/\n/g, '<br>');
        contentElement.innerHTML = withBreaks;
        scrollToBottom();
      }
    }

    // æµå¼å†…å®¹ç´¯ç§¯å™¨ï¼ˆå‚è€ƒæµå¼è§£æå·¥å…·çš„æ€è·¯ï¼‰
    class StreamingContentAccumulator {
      constructor(onUpdate) {
        this.buffer = '';
        this.onUpdate = onUpdate;
      }
      
      addChunk(chunk) {
        this.buffer += chunk;
        // æ¯æ¬¡æ·»åŠ æ–°å†…å®¹åï¼Œå®Œæ•´æ ¼å¼åŒ–å¹¶æ›´æ–°æ˜¾ç¤º
        this.onUpdate(this.buffer);
      }
      
      // æ–°å¢ï¼šç›´æ¥è®¾ç½®å®Œæ•´å†…å®¹ï¼ˆç”¨äºç´¯ç§¯å‹æµå¼å“åº”ï¼‰
      setFullContent(fullContent) {
        this.buffer = fullContent;
        this.onUpdate(this.buffer);
      }
      
      getContent() {
        return this.buffer;
      }
      
      reset() {
        this.buffer = '';
      }
    }

    // å‘é€æ¶ˆæ¯
    async function sendMessage(content) {
      if (!content.trim()) return;
      
      // æ˜¾ç¤ºèŠå¤©åŒºåŸŸ
      if (!isConversationStarted) {
        showChatMessages();
      }
      
      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      const userMsg = {
        id: Date.now(),
        isUser: true,
        content: content,
        timestamp: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
      };
      
      conversationMessages.push(userMsg);
      appendMessage(userMsg);
      
      // ä¿å­˜åˆ° localStorage
      Storage.set('chatMessages', conversationMessages);
      
      // æ˜¾ç¤ºæ‰“å­—åŠ¨ç”»
      showTypingIndicator();
      
      // è°ƒç”¨çœŸå® API æµå¼è¾“å‡º
      try {
        // å…ˆéšè—æ‰“å­—åŠ¨ç”»
        hideTypingIndicator();
        
        // åˆ›å»ºæ¶ˆæ¯å®¹å™¨
        const msgId = Date.now() + 1;
        const aiMsg = {
          id: msgId,
          isUser: false,
          content: '',
          timestamp: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
        };
        
        conversationMessages.push(aiMsg);
        appendStreamingMessage(aiMsg);
        
        // è°ƒç”¨æµå¼ APIï¼Œä½¿ç”¨ç´¯ç§¯å™¨
        const accumulator = new StreamingContentAccumulator((fullContent) => {
          // æ›´æ–°æ¶ˆæ¯å†…å®¹å’Œæ˜¾ç¤º
          const lastMsg = conversationMessages[conversationMessages.length - 1];
          if (lastMsg && lastMsg.id === msgId) {
            lastMsg.content = fullContent;
            updateStreamingMessage(msgId, fullContent);
          }
        });
        
        await callAIAPIStreaming(content, currentConversationId, (chunk) => {
          // ç´¯ç§¯å¢é‡å†…å®¹
          accumulator.addChunk(chunk);
        });
        
        // ç¡®ä¿æœ€ç»ˆå†…å®¹å·²ä¿å­˜å¹¶é‡æ–°æ ¼å¼åŒ–
        const lastMsg = conversationMessages[conversationMessages.length - 1];
        if (lastMsg && lastMsg.id === msgId) {
          lastMsg.content = accumulator.getContent();
          // æµå¼ç»“æŸåï¼Œæ ¼å¼åŒ–å®Œæ•´å†…å®¹
          const formattedContent = formatMessageContent(lastMsg.content);
          const contentElement = document.getElementById(`msg-content-${msgId}`);
          if (contentElement) {
            contentElement.innerHTML = formattedContent;
          }
        }
        
        // ä¿å­˜å®Œæ•´æ¶ˆæ¯
        Storage.set('chatMessages', conversationMessages);
        
      } catch (error) {
        // å‘é€æ¶ˆæ¯å¤±è´¥
        hideTypingIndicator();
        
        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        const errorMsg = {
          id: Date.now() + 1,
          isUser: false,
          content: 'æŠ±æ­‰ï¼ŒæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•ã€‚',
          timestamp: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
        };
        
        conversationMessages.push(errorMsg);
        appendMessage(errorMsg);
        Storage.set('chatMessages', conversationMessages);
      }
    }

    // æ‰“å­—åŠ¨ç”»æ˜¾ç¤º
    function showTypingIndicator() {
      const container = document.getElementById('messagesContainer');
      if (!container) return;
      
      const typingDiv = document.createElement('div');
      typingDiv.className = 'message-item assistant';
      typingDiv.id = 'typingIndicator';
      typingDiv.innerHTML = `
        <div class="message-avatar">
          <img src="./assets/images/NiLing/peple.png" alt="å°é¢œåŒ»ç”Ÿ" onerror="this.parentElement.innerHTML='<i class=&quot;fas fa-user-nurse&quot;></i>'">
        </div>
        <div class="message-bubble">
          <div class="typing-indicator">
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
          </div>
        </div>
      `;
      container.appendChild(typingDiv);
      scrollToBottom();
    }

    // éšè—æ‰“å­—åŠ¨ç”»
    function hideTypingIndicator() {
      const indicator = document.getElementById('typingIndicator');
      if (indicator) indicator.remove();
    }

    // AIå›å¤ç”Ÿæˆï¼ˆæ™ºèƒ½åŒ¹é…ï¼‰
    function generateAIResponse(userMsg) {
      const msg = userMsg.toLowerCase();
      
      // å…³é”®è¯åŒ¹é…å›å¤
      const responses = {
        'çƒ­ç›å‰': 'çƒ­ç›å‰æ˜¯ä¸€ç§å°„é¢‘ç´§è‚¤æŠ€æœ¯ï¼Œé€šè¿‡é«˜é¢‘ç”µæ³¢åŠ çƒ­çš®è‚¤æ·±å±‚ç»„ç»‡ï¼Œåˆºæ¿€èƒ¶åŸè›‹ç™½å†ç”Ÿã€‚é€šå¸¸èƒ½ç»´æŒ1-2å¹´æ•ˆæœï¼Œéœ€è¦ä¸“ä¸šåŒ»ç”Ÿæ“ä½œã€‚ç–¼ç—›æ„Ÿå› äººè€Œå¼‚ï¼Œå¯é€šè¿‡è¡¨é¢éº»é†‰ç¼“è§£ã€‚',
        'æ°´å…‰é’ˆ': 'æ°´å…‰é’ˆæ˜¯æ³¨å°„å¼æŠ¤è‚¤ï¼Œå»ºè®®æ¯3-4å‘¨è¿›è¡Œä¸€æ¬¡ï¼Œå…·ä½“é¢‘ç‡éœ€æ ¹æ®ä¸ªäººçš®è‚¤çŠ¶å†µè°ƒæ•´ã€‚ä¸»è¦ä½œç”¨æ˜¯è¡¥æ°´ã€æäº®è‚¤è‰²ã€æ”¹å–„ç»†çº¹ã€‚æœ¯å24å°æ—¶å†…é¿å…æ²¾æ°´ã€‚',
        'ç»å°¿é…¸': 'ç»å°¿é…¸èƒ½ç»´æŒ6-18ä¸ªæœˆä¸ç­‰ï¼Œå…·ä½“å–å†³äºäº§å“ç±»å‹ã€æ³¨å°„éƒ¨ä½å’Œä¸ªäººä»£è°¢é€Ÿåº¦ã€‚å“è´¨ç»å°¿é…¸å‰¯ä½œç”¨å¾ˆå°ï¼Œå…³é”®æ˜¯é€‰æ‹©æ­£è§„æœºæ„å’Œæœ‰èµ„è´¨åŒ»ç”Ÿã€‚',
        'æŠ—è¡°': 'æŠ—è¡°è€æ˜¯ç³»ç»Ÿæ€§å·¥ç¨‹ï¼šæ—¥å¸¸é˜²æ™’æ˜¯åŸºç¡€ã€é€‚åº¦è¿åŠ¨ä¿ƒè¿›æ–°é™ˆä»£è°¢ã€é€‰æ‹©é€‚åˆçš„åŒ»ç¾é¡¹ç›®ã€‚å»ºè®®ä»25å²èµ·å¼€å§‹æŠ—è¡°ç®¡ç†ã€‚',
        'å‰¯ä½œç”¨': 'æ­£è§„åŒ»ç–—æœºæ„ä½¿ç”¨è®¤è¯äº§å“è¿›è¡ŒåŒ»ç¾æ˜¯ç›¸å¯¹å®‰å…¨çš„ï¼Œä½†éœ€è¦é€‰æ‹©æœ‰èµ„è´¨çš„åŒ»ç”Ÿï¼Œå¹¶åšå¥½æœ¯å‰å’¨è¯¢å’Œæœ¯åæŠ¤ç†ã€‚',
        'å¹´é¾„': '18å²ä»¥ä¸Šå¯å¼€å§‹åŒ»ç¾ï¼Œä¸åŒå¹´é¾„æ®µå…³æ³¨ä¸åŒï¼š20-30å²é‡ç‚¹æ˜¯é¢„é˜²ï¼Œ30-40å²ç€é‡æŠ—è¡°ï¼Œ40+å²æ›´å…³æ³¨ä¿®å¤ã€‚',
        'æŠ¤ç†': 'æœ¯åæŠ¤ç†å¾ˆå…³é”®ï¼šâ‘ ä¸¥æ ¼é˜²æ™’ â‘¡é¿å…åˆºæ¿€æ€§æŠ¤è‚¤å“ â‘¢ä¿æŒæ¸…æ´ â‘£éµåŒ»å˜±ç”¨è¯ â‘¤å¿ŒçƒŸé…’è¾›è¾£ â‘¥å……è¶³ç¡çœ ã€‚',
        'è¡°è€': 'è¡°è€ä¸»è¦ç”±ä¸‰å¤§å› ç´ å¯¼è‡´ï¼šâ‘ è‡ªç„¶è€åŒ–ï¼ˆåŸºå› ï¼‰â‘¡å…‰è€åŒ–ï¼ˆç´«å¤–çº¿ï¼‰â‘¢æ°§åŒ–åº”æ¿€ï¼ˆè‡ªç”±åŸºï¼‰ã€‚ç§‘å­¦æŠ—è¡°éœ€è¦ä¸‰è€…å…¼é¡¾ã€‚',
        'æ¾å¼›': 'é¢éƒ¨æ¾å¼›å¯é€šè¿‡çƒ­ç›å‰ã€è¶…å£°åˆ€ã€çº¿é›•ç­‰æ–¹å¼æ”¹å–„ï¼Œæ ¹æ®æ¾å¼›ç¨‹åº¦é€‰æ‹©ï¼Œä¸­åº¦å»ºè®®çƒ­ç›å‰ï¼Œé‡åº¦å¯è€ƒè™‘çº¿é›•ã€‚',
        'ç»†çº¹': 'ç»†çº¹å½¢æˆå› ç¼ºæ°´ã€èƒ¶åŸæµå¤±ï¼Œå¯é€šè¿‡æ°´å…‰é’ˆã€è‚‰æ¯’ç´ ã€å…‰å­å«©è‚¤ç­‰æ”¹å–„ï¼ŒåŒæ—¶æ—¥å¸¸ä¿æ¹¿å’Œé˜²æ™’å¾ˆé‡è¦ã€‚',
        'è¶…å£°åˆ€': 'è¶…å£°åˆ€æ˜¯æ·±å±‚èšç„¦è¶…å£°æ³¢æŠ€æœ¯ï¼Œæå‡æ•ˆæœæ¯”çƒ­ç›å‰æ›´å¼ºï¼Œèƒ½ç»´æŒ2-3å¹´ã€‚ç–¼ç—›æ„Ÿè¾ƒå¼ºï¼Œéœ€è¦æ•·éº»ã€‚é€‚åˆä¸­é‡åº¦æ¾å¼›ã€‚',
        'é˜²æ™’': 'é˜²æ™’æ˜¯æŠ—è¡°ç¬¬ä¸€è¦åŠ¡ï¼ç´«å¤–çº¿é€ æˆ80%çš®è‚¤è€åŒ–ï¼Œå¿…é¡»æ¯å¤©ä½¿ç”¨SPF30+é˜²æ™’éœœï¼Œæ¯2å°æ—¶è¡¥æ¶‚ã€‚é˜´å¤©ä¹Ÿè¦é˜²æ™’ã€‚',
        'é£Ÿç‰©': 'æŠ—è¡°å¤šåƒï¼šâ‘ å¯Œå«ç»´Cçš„æ°´æœï¼ˆè“è“ã€ç•ªèŒ„ï¼‰â‘¡ä¼˜è´¨è›‹ç™½ â‘¢åšæœï¼ˆå¯Œå«ç»´Eï¼‰â‘£æ·±æµ·é±¼ï¼ˆOmega3ï¼‰â‘¤ç»¿èŒ¶ï¼ˆæŠ—æ°§åŒ–ï¼‰',
        'é¡¹ç›®': 'ç›¸å¯¹å®‰å…¨çš„åŒ»ç¾é¡¹ç›®ï¼šè‚‰æ¯’ç´ ã€ç»å°¿é…¸ã€å…‰å­å«©è‚¤ã€çƒ­ç›å‰ã€æ°´å…‰é’ˆç­‰ã€‚å…³é”®æ˜¯é€‰æ‹©åˆè§„äº§å“å’Œä¸“ä¸šåŒ»ç”Ÿã€‚',
        'è®¡åˆ’': 'å»ºè®®ï¼šè½»åº¦æ¾å¼›é€‰çƒ­ç›å‰ï¼›ä¸¥é‡æ¾å¼›é€‰çº¿é›•ï¼›ç»†çº¹é€‰è‚‰æ¯’ç´ +ç»å°¿é…¸ï¼›è‰²æ–‘é€‰çš®ç§’/å…‰å­å«©è‚¤ã€‚æ ¹æ®é¢„ç®—å’Œéœ€æ±‚ç»„åˆã€‚',
        'æ•ˆæœ': 'æŠ—è¡°æ•ˆæœç»´æŒæ—¶é—´ï¼šçƒ­ç›å‰1-2å¹´ï¼Œè¶…å£°åˆ€2-3å¹´ï¼Œç»å°¿é…¸6-18ä¸ªæœˆï¼Œçº¿é›•1å¹´å·¦å³ã€‚å®šæœŸç»´æŠ¤å¯å»¶é•¿æ•ˆæœã€‚',
      };
      
      // ç²¾ç¡®åŒ¹é…
      for (let key in responses) {
        if (msg.includes(key)) {
          return responses[key];
        }
      }
      
      // æ¨¡ç³ŠåŒ¹é…
      if (msg.includes('ç–¼') || msg.includes('ç—›')) {
        return 'ç–¼ç—›æ„Ÿå› äººè€Œå¼‚ï¼šè‚‰æ¯’ç´ è½»å¾®é’ˆåˆºæ„Ÿã€æ°´å…‰é’ˆæœ‰èƒ€ç—›ã€çƒ­ç›å‰éœ€è¡¨é¢éº»é†‰ã€è¶…å£°åˆ€å’Œçº¿é›•ç—›æ„Ÿè¾ƒå¼ºä½†å¯å¿å—ã€‚æœ¯åä¼šæœ‰è½»å¾®ä¸é€‚ï¼Œ1-3å¤©æ¢å¤ã€‚';
      }
      
      if (msg.includes('å¤šä¹…') || msg.includes('ä¸€æ¬¡')) {
        return 'ä¸åŒé¡¹ç›®é¢‘ç‡ä¸åŒï¼š\nâ€¢ æ°´å…‰é’ˆï¼š3-4å‘¨/æ¬¡\nâ€¢ çƒ­ç›å‰ï¼š1å¹´/æ¬¡\nâ€¢ è‚‰æ¯’ç´ ï¼š6ä¸ªæœˆ/æ¬¡\nâ€¢ å…‰å­å«©è‚¤ï¼š1-3ä¸ªæœˆ/æ¬¡\n\nå…·ä½“éœ€è¦åŒ»ç”Ÿæ ¹æ®ä¸ªäººæƒ…å†µå®šåˆ¶æ–¹æ¡ˆã€‚';
      }
      
      // é»˜è®¤æ™ºèƒ½å›å¤
      return `å…³äºã€Œ${userMsg}ã€ï¼Œæˆ‘æ˜¯ä¸“ä¸šç¾è‚¤é¡¾é—®å°é¢œï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨è§£ç­”ï¼

ğŸ’¡ å»ºè®®æ‚¨ï¼š
1. å¯ä»¥ç‚¹å‡»ã€Œé€†é¾„ç§˜å¢ƒã€è¿›è¡Œå…è´¹é¢éƒ¨è¯„ä¼°
2. è·å–ä¸ªæ€§åŒ–çš„æ”¹å–„æ–¹æ¡ˆå’Œè´¹ç”¨å»ºè®®
3. æˆ–å’¨è¯¢æˆ‘ä»¬çš„ä¸“ä¸šç¾å®¹é¡¾é—®

æˆ‘å¯ä»¥å›ç­”æ‚¨çš„å…·ä½“é—®é¢˜ï¼Œæ¯”å¦‚ï¼š
â€¢ é¡¹ç›®é€‰æ‹©ã€æ•ˆæœã€å‰¯ä½œç”¨
â€¢ æœ¯åæŠ¤ç†ã€æ¢å¤æ—¶é—´
â€¢ è´¹ç”¨å‚è€ƒã€æœ€ä½³å¹´é¾„

è¯·å…·ä½“æè¿°æ‚¨å…³å¿ƒçš„é—®é¢˜ï¼Œæˆ‘ä¼šè¯¦ç»†ä¸ºæ‚¨è§£ç­”å“¦~ ğŸ˜Š`;
    }

    // è°ƒç”¨çœŸå® AI APIï¼ˆæµå¼è¾“å‡ºï¼‰
    async function callAIAPIStreaming(userMessage, conversationId = '', onChunk) {
      // æ£€æµ‹æ˜¯å¦ä¸º HTTPS ç¯å¢ƒï¼ˆéƒ¨ç½²ç¯å¢ƒï¼‰
      const isHTTPS = window.location.protocol === 'https:';
      const API_BASE = isHTTPS 
        ? '/.netlify/functions/api-proxy/v1'  // HTTPS ç¯å¢ƒä½¿ç”¨ä»£ç†
        : 'http://aie.wenge.com:30051/v1';     // HTTP ç¯å¢ƒç›´æ¥è°ƒç”¨
      const API_KEY = 'app-7GvRPyu0pd3wzK7YDWF6byue';
      
      try {
        const response = await fetch(`${API_BASE}/chat-messages`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${API_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            query: userMessage,
            response_mode: 'streaming',
            user: 'web-user-001',
            conversation_id: conversationId,
            inputs: {}
          })
        });

        if (!response.ok) {
          throw new Error(`APIé”™è¯¯: ${response.status}`);
        }
        
        // å¤„ç†æµå¼å“åº”
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let fullAnswer = '';
        
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          
          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop(); // ä¿ç•™ä¸å®Œæ•´çš„è¡Œ
          
          for (const line of lines) {
            if (line.trim().startsWith('data: ')) {
              try {
                const jsonData = line.substring(6).trim();
                if (!jsonData || jsonData === '') continue;
                
                const data = JSON.parse(jsonData);
                
                if (data.event === 'message') {
                  // æ¯æ¬¡æ”¶åˆ° message äº‹ä»¶ï¼Œanswer æ˜¯å¢é‡å†…å®¹ç‰‡æ®µ
                  const newAnswer = data.answer || '';
                  
                  // ç´¯ç§¯å®Œæ•´å†…å®¹
                  if (newAnswer) {
                    fullAnswer += newAnswer;
                    // ç›´æ¥ä¼ é€’å¢é‡ç‰‡æ®µ
                    onChunk(newAnswer);
                  }
                } else if (data.event === 'message_end') {
                  // ä¿å­˜ conversation_id
                  if (data.conversation_id) {
                    currentConversationId = data.conversation_id;
                    Storage.set('currentConversationId', currentConversationId);
                  }
                } else if (data.event === 'error') {
                  throw new Error(data.error || 'APIé”™è¯¯');
                }
              } catch (e) {
                console.error('è§£ææµæ•°æ®å¤±è´¥:', e, 'åŸå§‹æ•°æ®:', line);
              }
            }
          }
        }
        
      } catch (error) {
        throw error;
      }
    }

    // è°ƒç”¨çœŸå® AI APIï¼ˆé˜»å¡æ¨¡å¼ï¼Œé™çº§ä½¿ç”¨ï¼‰
    async function callAIAPI(userMessage, conversationId = '') {
      // æ£€æµ‹æ˜¯å¦ä¸º HTTPS ç¯å¢ƒï¼ˆéƒ¨ç½²ç¯å¢ƒï¼‰
      const isHTTPS = window.location.protocol === 'https:';
      const API_BASE = isHTTPS 
        ? '/.netlify/functions/api-proxy/v1'  // HTTPS ç¯å¢ƒä½¿ç”¨ä»£ç†
        : 'http://aie.wenge.com:30051/v1';     // HTTP ç¯å¢ƒç›´æ¥è°ƒç”¨
      const API_KEY = 'app-7GvRPyu0pd3wzK7YDWF6byue';
      
      try {
        const response = await fetch(`${API_BASE}/chat-messages`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${API_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            query: userMessage,
            response_mode: 'blocking',
            user: 'web-user-001',
            conversation_id: conversationId,
            inputs: {}
          })
        });

        if (!response.ok) {
          throw new Error(`APIé”™è¯¯: ${response.status}`);
        }
        
        const data = await response.json();
        
        // ä¿å­˜ conversation_id
        if (data.conversation_id) {
          currentConversationId = data.conversation_id;
          Storage.set('currentConversationId', currentConversationId);
        }
        
        return data.answer || 'æŠ±æ­‰ï¼Œæœªèƒ½è·å–å›å¤';
        
      } catch (error) {
        // é™çº§åˆ°æ¨¡æ‹Ÿå›å¤
        return generateAIResponse(userMessage);
      }
    }

    // é—®é¢˜æ•°æ®
    const questionTemplates = [
      { icon: 'fa-question', iconClass: 'question-icon-blue', text: 'è¡°è€çš„ä¸‰å¤§å› ç´ ?' },
      { icon: 'fa-heart', iconClass: 'question-icon-pink', text: 'çƒ­ç›å‰çœŸçš„æœ‰æ•ˆæœå—?' },
      { icon: 'fa-shield-alt', iconClass: 'question-icon-green', text: 'ç«¥é¢œé’ˆå¯¹äººä½“æœ‰æ²¡æœ‰å±å®³?' },
      { icon: 'fa-star', iconClass: 'question-icon-blue', text: 'é¢éƒ¨æ¾å¼›å¦‚ä½•æ”¹å–„?' },
      { icon: 'fa-droplet', iconClass: 'question-icon-pink', text: 'æ°´å…‰é’ˆå¤šä¹…åšä¸€æ¬¡?' },
      { icon: 'fa-bolt', iconClass: 'question-icon-blue', text: 'è¶…å£°åˆ€æ•ˆæœæ€ä¹ˆæ ·?' },
      { icon: 'fa-sun', iconClass: 'question-icon-pink', text: 'æ—¥å¸¸é˜²æ™’æœ‰å¤šé‡è¦?' },
      { icon: 'fa-leaf', iconClass: 'question-icon-green', text: 'æŠ—è¡°åƒä»€ä¹ˆé£Ÿç‰©å¥½?' },
      { icon: 'fa-fire', iconClass: 'question-icon-pink', text: 'çƒ­ç›å‰ç–¼ä¸ç–¼?' },
      { icon: 'fa-eye', iconClass: 'question-icon-blue', text: 'çœ¼éƒ¨ç»†çº¹æ€ä¹ˆå»é™¤?' },
      { icon: 'fa-magic', iconClass: 'question-icon-pink', text: 'å“ªäº›åŒ»ç¾é¡¹ç›®å®‰å…¨?' },
      { icon: 'fa-clock', iconClass: 'question-icon-blue', text: 'åšåŒ»ç¾çš„æœ€ä½³å¹´é¾„?' },
      { icon: 'fa-gem', iconClass: 'question-icon-green', text: 'ç»å°¿é…¸èƒ½ç»´æŒå¤šä¹…?' },
      { icon: 'fa-flask', iconClass: 'question-icon-blue', text: 'è‚‰æ¯’ç´ æœ‰å‰¯ä½œç”¨å—?' },
      { icon: 'fa-sparkles', iconClass: 'question-icon-pink', text: 'å¦‚ä½•é€‰æ‹©åˆé€‚çš„é¡¹ç›®?' },
      { icon: 'fa-hands-helping', iconClass: 'question-icon-green', text: 'åŒ»ç¾æœ¯åå¦‚ä½•æŠ¤ç†?' },
      { icon: 'fa-chart-line', iconClass: 'question-icon-blue', text: 'æŠ—è¡°æ•ˆæœèƒ½æŒç»­å¤šä¹…?' },
      { icon: 'fa-calendar-check', iconClass: 'question-icon-pink', text: 'å¤šä¹…åšä¸€æ¬¡åŒ»ç¾åˆé€‚?' },
      { icon: 'fa-lightbulb', iconClass: 'question-icon-green', text: 'æ—¥å¸¸æŠ¤è‚¤è¦æ³¨æ„ä»€ä¹ˆ?' },
      { icon: 'fa-heartbeat', iconClass: 'question-icon-blue', text: 'å¦‚ä½•ä¿æŒå¹´è½»çŠ¶æ€?' },
    ];

    // æ¸²æŸ“é—®é¢˜ï¼ˆåˆ†æˆä¸‰æ’ï¼Œç¡®ä¿é—´è·ä¸€è‡´ï¼‰
    function renderQuestions() {
      const wrapper = document.getElementById('questionsScrollWrapper');
      
      // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
      if (!wrapper) {
        console.error('questionsScrollWrapper å…ƒç´ ä¸å­˜åœ¨');
        return;
      }
      
      // æ¸…ç©ºå®¹å™¨
      wrapper.innerHTML = '';
      
      // æ£€æŸ¥é—®é¢˜æ¨¡æ¿æ˜¯å¦ä¸ºç©º
      if (!questionTemplates || questionTemplates.length === 0) {
        console.error('é—®é¢˜æ¨¡æ¿ä¸ºç©º');
        return;
      }
      
      // å°†é—®é¢˜å°½å¯èƒ½å‡åŒ€åœ°åˆ†æˆä¸‰æ’
      const rows = [[], [], []];
      const totalQuestions = questionTemplates.length;
      const questionsPerRow = Math.ceil(totalQuestions / 3);
      
      // æŒ‰é¡ºåºåˆ†é…åˆ°ä¸‰æ’ï¼Œç¡®ä¿å°½å¯èƒ½å‡åŒ€
      questionTemplates.forEach((question, index) => {
        const rowIndex = Math.floor(index / questionsPerRow);
        if (rowIndex < 3) {
          rows[rowIndex].push(question);
        }
      });
      
      // åˆ›å»ºåŸå§‹å†…å®¹å’Œå…‹éš†å†…å®¹
      const originalContainer = createRowsContainer(rows);
      const clonedContainer = originalContainer.cloneNode(true);
      
      wrapper.appendChild(originalContainer);
      wrapper.appendChild(clonedContainer);
      
      console.log('é—®é¢˜å·²æ¸²æŸ“ï¼Œå…±', totalQuestions, 'ä¸ªé—®é¢˜');
    }
    
    // åˆ›å»ºä¸‰æ’è½®æ’­å®¹å™¨
    function createRowsContainer(rows) {
      const swiper = document.createElement('div');
      swiper.className = 'questions-swiper';
      
      // åˆ›å»ºä¸‰æ’
      rows.forEach((row, rowIndex) => {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'question-row';
        
        row.forEach(question => {
          const card = createQuestionCard(question);
          rowDiv.appendChild(card);
        });
        
        swiper.appendChild(rowDiv);
        console.log(`ç¬¬${rowIndex + 1}æ’åˆ›å»ºäº†${row.length}ä¸ªé—®é¢˜`);
      });
      
      return swiper;
    }

    // åˆ›å»ºé—®é¢˜å¡ç‰‡
    function createQuestionCard(question) {
      const div = document.createElement('div');
      div.className = 'question-card';
      div.onclick = () => handleQuestion(question.text);
      
      div.innerHTML = `
        <div class="question-icon ${question.iconClass}">
          <i class="fas ${question.icon}"></i>
        </div>
        <div class="question-text">${question.text}</div>
      `;
      
      return div;
    }

    // è‡ªåŠ¨æ»šåŠ¨åŠŸèƒ½ï¼ˆæ°´å¹³ï¼‰
    let autoScrollInterval;
    let isUserScrolling = false;
    let isPaused = false;
    let manualScrollTimeout;

    function initAutoScroll() {
      const container = document.getElementById('questionsScrollContainer');
      const wrapper = document.getElementById('questionsScrollWrapper');
      const autoScrollSpeed = 3.6; // æ»šåŠ¨é€Ÿåº¦ï¼ˆåŠ é€Ÿ3å€ï¼‰
      
      // ä½¿ç”¨requestAnimationFrameæ›¿ä»£setIntervalï¼Œæ›´æµç•…
      function animate() {
        if (!isPaused && !isUserScrolling && wrapper.children.length > 0) {
          const originalSwiper = wrapper.children[0];
          if (originalSwiper) {
            container.scrollLeft += autoScrollSpeed;
            const originalWidth = originalSwiper.offsetWidth + 12;
            
            if (container.scrollLeft >= originalWidth) {
              container.scrollLeft -= originalWidth;
            }
          }
        }
        requestAnimationFrame(animate);
      }
      
      // ç«‹å³å¼€å§‹åŠ¨ç”»
      requestAnimationFrame(animate);
      
      // ç›‘å¬æ‰‹åŠ¨æ»šåŠ¨
      container.addEventListener('scroll', () => {
        clearTimeout(manualScrollTimeout);
        isUserScrolling = true;
        
        manualScrollTimeout = setTimeout(() => {
          isUserScrolling = false;
        }, 2000);
      });
      
      // é¼ æ ‡æ‚¬åœæ—¶æš‚åœ
      container.addEventListener('mouseenter', () => {
        isPaused = true;
      });
      
      container.addEventListener('mouseleave', () => {
        isPaused = false;
      });
    }

    // å¤„ç†èƒ½åŠ›å¡ç‰‡ç‚¹å‡»
    function openCapability(type) {
      console.log('Opening capability:', type);
      
      // æ›´æ–°æ¿€æ´»çŠ¶æ€
      const cards = document.querySelectorAll('.capability-card');
      cards.forEach(card => card.classList.remove('active'));
      event.currentTarget.classList.add('active');
      
      // æ ¹æ®ç±»å‹è·³è½¬
      setTimeout(() => {
        switch(type) {
          case 'encyclopedia':
            // è·³è½¬åˆ°æŠ—è¡°ç™¾ç§‘ï¼ˆå·²éšè—ï¼‰
            // window.location.href = './pages-chat/community/index.html';
            break;
          case 'assessment':
            // è·³è½¬åˆ°é€†é¾„ç§˜å¢ƒï¼ˆè¯„ä¼°åŠŸèƒ½ï¼‰
            window.location.href = '/web/pages-chat/assessment/guide.html';
            break;
          case 'care':
            // è·³è½¬åˆ°æœ¯åç®¡å®¶
            // æš‚æ—¶è·³è½¬åˆ°é¢„çº¦é¡µé¢  
            window.location.href = '/web/pages-chat/profile/appointments.html';
            break;
          default:
            console.log('Unknown capability:', type);
        }
      }, 300);
    }

    // å¤„ç†é—®é¢˜ç‚¹å‡»
    function handleQuestion(question) {
      console.log('Question clicked:', question);
      // ç›´æ¥å‘é€æ¶ˆæ¯
      sendMessage(question);
    }

    // å¤„ç†å›è½¦é”®
    function handleEnterKey(event) {
      if (event.key === 'Enter') {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        
        if (message) {
          sendMessage(message);
          input.value = '';
        }
      }
    }

    // è¯·æ±‚éº¦å…‹é£æƒé™
    async function requestMicrophonePermission() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        stream.getTracks().forEach(track => track.stop()); // ç«‹å³åœæ­¢æµï¼Œåªæ˜¯ç”¨äºè·å–æƒé™
        hasPermission = true;
        return true;
      } catch (error) {
        console.error('Permission denied:', error);
        alert('éœ€è¦éº¦å…‹é£æƒé™æ‰èƒ½ä½¿ç”¨è¯­éŸ³åŠŸèƒ½ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸éº¦å…‹é£è®¿é—®');
        hasPermission = false;
        return false;
      }
    }

    // å¼€å§‹å½•éŸ³
    async function startRecording() {
      if (!hasPermission) {
        const gotPermission = await requestMicrophonePermission();
        if (!gotPermission) return;
      }

      // å¦‚æœå·²ç»åœ¨å½•éŸ³ï¼Œå…ˆåœæ­¢ä¹‹å‰çš„å½•éŸ³
      if (isRecording) {
        stopRecording();
      }

      // æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      if (recordingTimer) {
        clearInterval(recordingTimer);
      }

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioChunks = [];
        
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            audioChunks.push(event.data);
          }
        };

        mediaRecorder.onstop = () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          handleRecordingComplete(audioBlob);
          
          stream.getTracks().forEach(track => track.stop());
        };

        mediaRecorder.start();
        isRecording = true;
        recordingStartTime = Date.now();
        
        // æ˜¾ç¤ºå½•éŸ³æç¤º
        const indicator = document.getElementById('recordingIndicator');
        const voiceButton = document.getElementById('voiceButton');
        indicator.classList.add('active');
        voiceButton.classList.add('recording');
        
        // å¼€å§‹å½•éŸ³è®¡æ—¶
        startRecordingTimer();
        
        console.log('Recording started');
      } catch (error) {
        console.error('Error starting recording:', error);
        alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®');
      }
    }

    // åœæ­¢å½•éŸ³
    function stopRecording() {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
        
        // éšè—å½•éŸ³æç¤º
        const indicator = document.getElementById('recordingIndicator');
        const voiceButton = document.getElementById('voiceButton');
        indicator.classList.remove('active');
        voiceButton.classList.remove('recording');
        
        // æ¸…é™¤è®¡æ—¶å™¨
        if (recordingTimer) {
          clearInterval(recordingTimer);
          recordingTimer = null;
        }
        
        // é‡ç½®æ—¶é—´æ˜¾ç¤º
        const timeSpan = document.getElementById('recordingText');
        if (timeSpan) {
          timeSpan.textContent = '';
        }
        
        console.log('Recording stopped');
      }
    }

    // å½•éŸ³å®Œæˆåå¤„ç†
    async function handleRecordingComplete(audioBlob) {
      console.log('Recording completed, audio size:', audioBlob.size);
      
      // æ˜¾ç¤ºèŠå¤©åŒºåŸŸï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
      if (!isConversationStarted) {
        showChatMessages();
      }
      
      // å°è¯•Web Speech APIè¯†åˆ«ï¼ˆç›´æ¥è¯†åˆ«ï¼Œä¸éœ€è¦éŸ³é¢‘æ–‡ä»¶ï¼‰
      const recognizedText = await startWebSpeechRecognition();
      
      if (recognizedText && recognizedText.trim()) {
        // è¯†åˆ«æˆåŠŸï¼Œå‘é€æ–‡å­—æ¶ˆæ¯
        sendMessage(recognizedText);
      } else {
        // è¯†åˆ«å¤±è´¥ï¼Œæ˜¾ç¤ºä¸ºè¯­éŸ³æ¶ˆæ¯
        const voiceMsg = {
          id: Date.now(),
          isUser: true,
          content: 'ğŸ¤ [è¯­éŸ³æ¶ˆæ¯]',
          type: 'audio',
          timestamp: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
        };
        
        conversationMessages.push(voiceMsg);
        appendMessage(voiceMsg);
        Storage.set('chatMessages', conversationMessages);
      }
    }

    // Web Speech API è¯­éŸ³è¯†åˆ«ï¼ˆç›´æ¥è¯†åˆ«ï¼‰
    async function startWebSpeechRecognition() {
      return new Promise((resolve) => {
        // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          
          try {
            const recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = false;
            recognition.interimResults = false;
            
            recognition.onresult = (event) => {
              const text = event.results[0][0].transcript;
              console.log('è¯­éŸ³è¯†åˆ«ç»“æœ:', text);
              resolve(text);
            };
            
            recognition.onerror = (error) => {
              console.log('è¯­éŸ³è¯†åˆ«å¤±è´¥:', error);
              resolve('');
            };
            
            recognition.onend = () => {
              resolve('');
            };
            
            // å¼€å§‹è¯†åˆ«
            recognition.start();
            
            // è¶…æ—¶å¤„ç†ï¼ˆ5ç§’ï¼‰
            setTimeout(() => {
              recognition.stop();
              resolve('');
            }, 5000);
            
          } catch (error) {
            console.log('è¯­éŸ³è¯†åˆ«ä¸å¯ç”¨:', error);
            resolve('');
          }
        } else {
          console.log('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«');
          resolve('');
        }
      });
    }

    // å½•éŸ³è®¡æ—¶å™¨
    let recordingSeconds = 0;
    function startRecordingTimer() {
      recordingSeconds = 0;
      
      // æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨
      if (recordingTimer) {
        clearInterval(recordingTimer);
      }
      
      // ç«‹å³æ˜¾ç¤ºåˆå§‹æ—¶é—´
      const timeSpan = document.getElementById('recordingText');
      if (timeSpan) {
        timeSpan.textContent = 'æ­£åœ¨å½•éŸ³ä¸­... 0:00';
      }
      
      recordingTimer = setInterval(() => {
        recordingSeconds++;
        const timeSpan = document.getElementById('recordingText');
        if (timeSpan) {
          const minutes = Math.floor(recordingSeconds / 60);
          const secs = recordingSeconds % 60;
          timeSpan.textContent = `æ­£åœ¨å½•éŸ³ä¸­... ${minutes}:${secs.toString().padStart(2, '0')}`;
        }
      }, 1000);
    }

    // å¤„ç†è¯­éŸ³è¾“å…¥ï¼ˆé•¿æŒ‰ï¼‰
    let mouseDownTime = null;
    let isLongPressing = false;
    let recordingTimeout = null;

    function handleVoiceInput(event) {
      // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œé˜²æ­¢é¡µé¢æ»šåŠ¨
      event.preventDefault();
      event.stopPropagation();
      
      mouseDownTime = Date.now();
      isLongPressing = false;
      
      // å»¶è¿Ÿ300msåå¼€å§‹å½•éŸ³ï¼ˆé˜²æ­¢è¯¯è§¦ï¼‰
      recordingTimeout = setTimeout(() => {
        isLongPressing = true;
        startRecording();
      }, 300);
    }

    function stopRecordingOnRelease(event) {
      // é˜»æ­¢é»˜è®¤è¡Œä¸ºå’Œäº‹ä»¶å†’æ³¡
      if (event) {
        event.preventDefault();
        event.stopPropagation();
      }
      
      if (recordingTimeout) {
        clearTimeout(recordingTimeout);
        recordingTimeout = null;
      }
      
      // å¦‚æœå·²ç»å¼€å§‹å½•éŸ³ï¼Œåˆ™åœæ­¢
      if (isLongPressing && isRecording) {
        stopRecording();
      }
      
      isLongPressing = false;
    }

    // æ¢ä¸€æ¢åŠŸèƒ½
    function refreshQuestions(event) {
      // æ·»åŠ æ—‹è½¬åŠ¨ç”»
      const button = event.currentTarget;
      const icon = button.querySelector('i');
      icon.style.animation = 'rotate 0.5s ease';
      
      // æ‰“ä¹±é—®é¢˜æ•°ç»„
      const shuffled = [...questionTemplates].sort(() => Math.random() - 0.5);
      
      // ä¸´æ—¶æ›¿æ¢questionTemplates
      const original = [...questionTemplates];
      questionTemplates.length = 0;
      questionTemplates.push(...shuffled);
      
      // é‡æ–°æ¸²æŸ“
      renderQuestions();
      
      // æ¢å¤åŸå§‹æ•°ç»„
      questionTemplates.length = 0;
      questionTemplates.push(...original);
      
      // é‡æ–°åº”ç”¨åŠ¨ç”»
      setTimeout(() => {
        animateQuestionCards();
      }, 100);
      
      // åŠ¨ç”»ç»“æŸåæ¸…ç†
      setTimeout(() => {
        icon.style.animation = '';
      }, 500);
    }

    // ç²’å­ç”Ÿæˆå™¨
    function createParticles() {
      const container = document.getElementById('particleContainer');
      const particleCount = 30; // æ§åˆ¶ç²’å­æ•°é‡
      
      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        
        // éšæœºä½ç½®
        particle.style.left = Math.random() * 100 + '%';
        particle.style.top = Math.random() * 100 + '%';
        
        // éšæœºåŠ¨ç”»å»¶è¿Ÿ
        particle.style.animationDelay = Math.random() * 20 + 's';
        particle.style.animationDuration = (15 + Math.random() * 10) + 's';
        
        container.appendChild(particle);
      }
    }

    // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
    window.addEventListener('beforeunload', function() {
      if (isRecording) {
        stopRecording();
      }
      if (recordingTimer) {
        clearInterval(recordingTimer);
      }
      if (recordingTimeout) {
        clearTimeout(recordingTimeout);
      }
    });

    // ==================== Sticky Header æ»šåŠ¨æ§åˆ¶ ====================
    let lastScrollTop = 0;
    const STICKY_THRESHOLD = 250;
    let ticking = false;

    function updateStickyHeader() {
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const stickyHeader = document.getElementById('stickyHeader');
      const stickyCardsSection = document.getElementById('stickyCardsSection');
      const floatingButton = document.querySelector('.floating-profile-button');
      
      if (scrollTop > STICKY_THRESHOLD) {
        if (stickyHeader) stickyHeader.classList.remove('hidden');
        if (stickyCardsSection) stickyCardsSection.classList.remove('hidden');
        // éšè—æµ®åŠ¨æŒ‰é’®
        if (floatingButton) floatingButton.style.display = 'none';
      } else {
        if (stickyHeader) stickyHeader.classList.add('hidden');
        if (stickyCardsSection) stickyCardsSection.classList.add('hidden');
        // æ˜¾ç¤ºæµ®åŠ¨æŒ‰é’®
        if (floatingButton) floatingButton.style.display = 'flex';
      }
      
      lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
    }

    // ä¼˜åŒ–çš„æ»šåŠ¨ç›‘å¬
    window.addEventListener('scroll', function() {
      if (!ticking) {
        window.requestAnimationFrame(function() {
          updateStickyHeader();
          ticking = false;
        });
        ticking = true;
      }
    }, { passive: true });

    // é—®é¢˜å¡ç‰‡åŠ¨ç”»å‡½æ•°
    function animateQuestionCards() {
      const questionCards = document.querySelectorAll('.question-card');
      if (questionCards.length === 0) {
        console.log('æœªæ‰¾åˆ°é—®é¢˜å¡ç‰‡ï¼Œå»¶è¿Ÿæ‰§è¡ŒåŠ¨ç”»');
        setTimeout(animateQuestionCards, 100);
        return;
      }
      
      questionCards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'scale(0.8)';
        card.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        
        setTimeout(() => {
          card.style.opacity = '1';
          card.style.transform = 'scale(1)';
        }, 50 + (index * 10));
      });
    }

    // é¡µé¢åŠ è½½åŠ¨ç”»
    document.addEventListener('DOMContentLoaded', function() {
      // åˆ›å»ºèƒŒæ™¯ç²’å­
      createParticles();
      
      // å…ˆæ¸²æŸ“é—®é¢˜
      renderQuestions();
      
      // åˆå§‹åŒ–è‡ªåŠ¨æ»šåŠ¨ï¼ˆé¡µé¢æ‰“å¼€å°±å¼€å§‹æ»šï¼‰
      initAutoScroll();
      
      // åˆå§‹åŒ–èŠå¤©åŠŸèƒ½
      initChat();

      // åˆå§‹åŒ–sticky headerçŠ¶æ€
      updateStickyHeader();

      // èƒ½åŠ›å¡ç‰‡åŠ¨ç”»
      const capabilityCards = document.querySelectorAll('.capability-card');
      capabilityCards.forEach((card, index) => {
        setTimeout(() => {
          card.style.opacity = '0';
          card.style.transform = 'scale(0.8)';
          card.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
          
          setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'scale(1)';
          }, 50);
        }, index * 80);
      });

      // é—®é¢˜å¡ç‰‡åŠ¨ç”»ï¼ˆå»¶è¿Ÿæ‰§è¡Œç¡®ä¿å·²ç»æ¸²æŸ“ï¼‰
      setTimeout(() => {
        animateQuestionCards();
      }, 100);
    });
  </script>

  </div> <!-- ç»“æŸ main-content-wrapper -->
</body>
</html>


